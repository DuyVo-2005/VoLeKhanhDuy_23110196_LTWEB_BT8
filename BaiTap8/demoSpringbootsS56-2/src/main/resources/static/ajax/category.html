<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Category CRUD</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="container mt-4">

	<h3>Category CRUD with AJAX - Duy Shop</h3>

	<!-- Form Thêm Mới -->
	<form id="addCategoryForm" enctype="multipart/form-data">
		<div class="mb-3">
			<label>Name</label> <input type="text" id="categoryName"
				class="form-control" required>
		</div>
		<div class="mb-3">
			<label>Icon</label> <input type="file" id="icon" class="form-control">
			<div id="preview" class="mt-2"></div>
		</div>
		<button type="submit" class="btn btn-primary">Add Category</button>
	</form>

	<hr>

	<!-- Bảng hiển thị -->
	<table class="table table-bordered" id="categoryTable">
		<thead>
			<tr>
				<th>ID</th>
				<th>Name</th>
				<th>Icon</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<!-- Modal Edit Category -->
	<div class="modal fade" id="editCategoryModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form id="editCategoryForm" enctype="multipart/form-data">
					<div class="modal-header">
						<h5 class="modal-title">Edit Category</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<input type="hidden" id="editCategoryId"> <input
							type="hidden" id="editOldIcon">

						<div class="mb-3">
							<label>Name</label> <input type="text" id="editCategoryName"
								class="form-control" required>
						</div>
						<div class="mb-3">
							<label>Icon</label> <input type="file" id="editIcon"
								class="form-control">
							<div id="editPreview" class="mt-2"></div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-primary">Save
							changes</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
const apiUrl = "http://localhost:8088/api/category";

// Load tất cả Category
function loadCategories() {
  $.get(apiUrl, function(res) {
    let rows = "";
    res.body.forEach(cat => {
      rows += `
        <tr>
          <td>${cat.categoryId}</td>
          <td>${cat.name}</td>
          <td>${cat.icon ? `<img src="/uploads/${cat.icon}" width="50">` : ""}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editCategory(${cat.categoryId})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.categoryId})">Delete</button>
          </td>
        </tr>
      `;
    });
    $("#categoryTable tbody").html(rows);
  });
}

// Thêm mới Category
$("#addCategoryForm").submit(function(e) {
  e.preventDefault();
  if ($("#icon")[0].files.length === 0) {
    alert("Bạn phải chọn ảnh khi thêm mới!");
    return;
  }
  let formData = new FormData();
  formData.append("categoryName", $("#categoryName").val());
  formData.append("icon", $("#icon")[0].files[0]);

  $.ajax({
    url: apiUrl + "/addCategory",
    type: "POST",
    data: formData,
    processData: false,
    contentType: false,
    success: function(res) {
      alert(res.message);
      loadCategories();
      $("#addCategoryForm")[0].reset();
      $("#preview").html("");
    },
    error: function(err) {
      alert("Add failed");
    }
  });
});

// Mở modal edit
function editCategory(id) {
  $.get(apiUrl + "/getCategory", { id: id }, function(res) {
    let cat = res.body;
    $("#editCategoryId").val(cat.categoryId);
    $("#editCategoryName").val(cat.name);
    $("#editOldIcon").val(cat.icon || "");
    $("#editPreview").html(cat.icon ? `<img src="/uploads/${cat.icon}" width="80">` : "");
    var modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
    modal.show();
  });
}

// Submit form Edit
$("#editCategoryForm").submit(function(e) {
  e.preventDefault();
  let id = $("#editCategoryId").val();
  let formData = new FormData();
  formData.append("categoryName", $("#editCategoryName").val());
  formData.append("categoryId", id);

  if ($("#editIcon")[0].files.length > 0) {
    formData.append("icon", $("#editIcon")[0].files[0]);
  } else {
    let oldIcon = $("#editOldIcon").val();
    formData.append("icon", new Blob(), oldIcon);
    formData.append("oldIcon", oldIcon);
  }

  $.ajax({
    url: apiUrl + "/updateCategory",
    type: "PUT",
    data: formData,
    processData: false,
    contentType: false,
    success: function(res) {
      alert(res.message);
      loadCategories();
      $("#editCategoryForm")[0].reset();
      $("#editPreview").html("");
      bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
    },
    error: function(err) {
      alert("Update failed");
    }
  });
});

// Xóa Category
function deleteCategory(id) {
  if (confirm("Are you sure?")) {
    $.ajax({
      url: apiUrl + "/deleteCategory",
      type: "DELETE",
      data: { categoryId: id },
      success: function(res) {
        alert(res.message);
        loadCategories();
      },
      error: function(err) {
        alert("Delete failed");
      }
    });
  }
}

// Preview icon thêm mới
$("#icon").change(function() {
  let file = this.files[0];
  if (file) {
    $("#preview").html(`<img src="${URL.createObjectURL(file)}" width="80">`);
  } else {
    $("#preview").html("");
  }
});

// Preview icon edit
$("#editIcon").change(function() {
  let file = this.files[0];
  if (file) {
    $("#editPreview").html(`<img src="${URL.createObjectURL(file)}" width="80">`);
  } else {
    $("#editPreview").html("");
  }
});

// Load page
loadCategories();
</script>
</body>
</html>
