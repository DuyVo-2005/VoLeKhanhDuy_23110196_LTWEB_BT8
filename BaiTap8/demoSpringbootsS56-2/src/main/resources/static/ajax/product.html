<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Category CRUD</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="container mt-4">

	<h3>Product CRUD with AJAX - Duy Shop</h3>

	<!-- Form Thêm Mới -->
	<form id="addProductForm" enctype="multipart/form-data">
		<div class="mb-3">
			<label>Product Name</label> <input type="text" id="productName"
				class="form-control" required>
		</div>

		<div class="mb-3">
			<label>Category Name</label> <select class="form-control"
				id="categorySelect" name="categoryId" required>
				<option value="">--- Select Category Name ---</option>
			</select>
		</div>

		<div class="mb-3">
			<label>Created Date</label> <input type="date" id="createdDate"
				class="form-control">
		</div>
		<div class="mb-3">
			<label>Description</label> <input type="text" id="description"
				class="form-control" required>
		</div>
		<div class="mb-3">
			<label>Discount</label> <input type="text" id="discount"
				class="form-control" placeholder="Enter float" required>
		</div>

		<div class="mb-3">
			<label>Quantity</label> <input type="text" id="quantity"
				class="form-control" placeholder="Enter integer" required>
		</div>

		<div class="mb-3">
			<label>Status</label> <input type="text" id="status"
				class="form-control" placeholder="Enter integer" required>
		</div>
		<div class="mb-3">
			<label>Unit Price</label> <input type="text" id="unitPrice"
				class="form-control" placeholder="Enter float" required>
		</div>
		<div class="mb-3">
			<label>Images</label> <input type="file" id="images"
				class="form-control">
			<div id="preview" class="mt-2"></div>
		</div>
		<button type="submit" class="btn btn-primary">Add Product</button>
	</form>

	<hr>

	<!-- Bảng hiển thị -->
	<table class="table table-bordered" id="productTable">
		<thead>
			<tr>
				<th>ID</th>
				<th>Product Name</th>
				<th>Created Date</th>
				<th>Description</th>
				<th>Discount</th>
				<th>Quantity</th>
				<th>Status</th>
				<th>Unit Price</th>
				<th>Images</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<!-- Modal Edit Category -->
	<div class="modal fade" id="editProductModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form id="editProductForm" enctype="multipart/form-data">
					<div class="modal-header">
						<h5 class="modal-title">Edit Category</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<input type="hidden" id="editProductId"> <input
							type="hidden" id="editOldImages">

						<div class="mb-3">
							<label>Product Name</label> <input type="text"
								id="editProductName" class="form-control" required>
						</div>
						<div class="mb-3">
							<label>Category Name</label> <select class="form-control"
								id="editCategorySelect" name="categoryId" required>
								<option value=""></option>
							</select>
						</div>
						<div class="mb-3">
							<label>Description</label> <input type="text"
								id="editDescription" class="form-control" required>
						</div>
						<div class="mb-3">
							<label>Discount</label> <input type="text" id="editDiscount"
								class="form-control" placeholder="Enter float" required>
						</div>
						<div class="mb-3">
							<label>Quantity</label> <input type="text" id="editQuantity"
								class="form-control" placeholder="Enter integer" required>
						</div>
						<div class="mb-3">
							<label>Status</label> <input type="text" id="editStatus"
								class="form-control" placeholder="Enter integer" required>
						</div>
						<div class="mb-3">
							<label>Unit Price</label> <input type="text" id="editUnitPrice"
								class="form-control" placeholder="Enter float" required>
						</div>
						<div class="mb-3">
							<label>Images</label> <input type="file" id="editImages"
								class="form-control">
							<div id="editPreview" class="mt-2"></div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-primary">Save
							changes</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- jQuery CDN -->
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

	<script>
	
	const apiUrlCategory = "http://localhost:8088/api/category";
	const apiUrlProduct = "http://localhost:8088/api/product";

	let categoryList = []; // biến global lưu danh sách category

	// Load category cho cả form thêm và form sửa
	$(document).ready(function() {
	    $.ajax({
	        url: apiUrlCategory,
	        method: "GET",
	        dataType: "json",
	        success: function(res) {
	            if(res.status) {
	                categoryList = res.body; // lưu danh sách category
	                const $select = $("#categorySelect"); // form thêm
	                categoryList.forEach(function(c) {
	                    $select.append($("<option></option>").val(c.categoryId).text(c.name));
	                });
	            }
	        },
	        error: function(xhr, status, error) {
	            console.error("Lỗi tải danh mục loại sản phẩm:", error);
	        }
	    });
	});

// Load tất cả Product
function loadProducts() {
  $.get(apiUrlProduct, function(res) {
    let rows = "";
    res.body.forEach(pro => {
      rows += `
        <tr>
    	  <td>${pro.productId}</td>
    	  <td>${pro.name}</td>
    	  <td>${pro.createdDate || ''}</td>
    	  <td>${pro.description || ''}</td>
    	  <td>${pro.discount || ''}</td>
    	  <td>${pro.quantity || ''}</td>
    	  <td>${pro.status || ''}</td>
    	  <td>${pro.unitPrice || ''}</td>
    	  <td>${pro.images ? `<img src="/uploads/${pro.images}" width="50">` : ''}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editProduct(${pro.productId})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${pro.productId})">Delete</button>
          </td>
        </tr>
      `;
    });
    $("#productTable tbody").html(rows);
  });
}

// Thêm mới Product
$("#addProductForm").submit(function(e) {
  e.preventDefault();
  if ($("#images")[0].files.length === 0) {
    alert("Bạn phải chọn ảnh khi thêm mới!");
    return;
  }
  let formData = new FormData();
  formData.append("productName", $("#productName").val());
  formData.append("categoryId", $("#categorySelect").val());
  formData.append("createdDate", $("#createdDate").val());
  formData.append("description", $("#description").val());
  formData.append("discount", $("#discount").val());
  formData.append("quantity", $("#quantity").val());
  formData.append("status", $("#status").val());
  formData.append("unitPrice", $("#unitPrice").val());
  formData.append("images", $("#images")[0].files[0]);

  $.ajax({
    url: apiUrlProduct + "/addProduct",
    type: "POST",
    data: formData,
    processData: false,
    contentType: false,
    success: function(res) {
      alert(res.message);
      loadProducts();
      $("#addProductForm")[0].reset();
      $("#preview").html("");
    },
    error: function(err) {
      alert("Add failed");
    }
  });
});

//Mở modal edit
function editProduct(id) {
  $.get(apiUrlProduct + "/getProduct", { id: id }, function(res) {
    let pro = res.body;
    $("#editProductId").val(pro.productId);
    $("#editProductName").val(pro.name);
    $("#editDescription").val(pro.description);
    $("#editDiscount").val(pro.discount);
    $("#editQuantity").val(pro.quantity);
    $("#editStatus").val(pro.status);
    $("#editUnitPrice").val(pro.unitPrice);
    $("#editOldImages").val(pro.images || "");
    $("#editPreview").html(pro.images ? `<img src="/uploads/${pro.images}" width="80">` : "");
    
    // Load select category cho form sửa
    const $editSelect = $("#editCategorySelect");
    $editSelect.empty();
    categoryList.forEach(function(c) {
        const $option = $("<option></option>").val(c.categoryId).text(c.name);
        if(pro.category && pro.category.categoryId === c.categoryId) {
            $option.prop("selected", true); // chọn giá trị hiện tại
        }
        $editSelect.append($option);
    });

    var modal = new bootstrap.Modal(document.getElementById('editProductModal'));
    modal.show();
  });
}

// Submit form Edit
$("#editProductForm").submit(function(e) {
  e.preventDefault();
  let id = $("#editProductId").val();
  let formData = new FormData();
  formData.append("productId", id);
  formData.append("productName", $("#editProductName").val());
  formData.append("description", $("#editDescription").val());
  formData.append("discount", $("#editDiscount").val());
  formData.append("quantity", $("#editQuantity").val());
  formData.append("status", $("#editStatus").val());
  formData.append("unitPrice", $("#editUnitPrice").val());
  formData.append("categoryId", $("#editCategorySelect").val());

  if ($("#editImages")[0].files.length > 0) {
    formData.append("images", $("#editImages")[0].files[0]);
  } else {
    let oldImages = $("#editOldImages").val();
    formData.append("images", new Blob(), oldImages);
    formData.append("oldImages", oldImages);
  }

  $.ajax({
    url: apiUrlProduct + "/updateProduct",
    type: "PUT",
    data: formData,
    processData: false,
    contentType: false,
    success: function(res) {
      alert(res.message);
      loadProducts();
      $("#editProductForm")[0].reset();
      $("#editPreview").html("");
      
   // Đóng modal edit
      const modalEl = document.getElementById('editProductModal');
      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modal.hide();
    },
    error: function(err) {
      alert("Update failed");
    }
  });
});

// Xóa Product
function deleteProduct(id) {
  if (confirm("Are you sure?")) {
    $.ajax({
      url: apiUrlProduct + "/deleteProduct",
      type: "DELETE",
      data: { productId: id },
      success: function(res) {
        alert(res.message);
        loadProducts();
      },
      error: function(err) {
        alert("Delete failed");
      }
    });
  }
}

// Preview images thêm mới
$("#images").change(function() {
  let file = this.files[0];
  if (file) {
    $("#preview").html(`<img src="${URL.createObjectURL(file)}" width="80">`);
  } else {
    $("#preview").html("");
  }
});

// Preview images edit
$("#editImages").change(function() {
  let file = this.files[0];
  if (file) {
    $("#editPreview").html(`<img src="${URL.createObjectURL(file)}" width="80">`);
  } else {
    $("#editPreview").html("");
  }
});

// Load page
loadProducts();
</script>
</body>
</html>
